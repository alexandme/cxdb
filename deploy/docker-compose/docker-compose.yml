version: '3.8'

services:
  # CXDB Server (Rust binary protocol + HTTP gateway)
  cxdb-server:
    build:
      context: ../..
      dockerfile: Dockerfile
    image: cxdb/cxdb:latest
    container_name: cxdb-server
    restart: unless-stopped
    ports:
      - "9009:9009"  # Binary protocol
      - "9010:9010"  # HTTP gateway
    volumes:
      - cxdb-data:/data
    environment:
      CXDB_DATA_DIR: /data
      CXDB_BIND: 0.0.0.0:9009
      CXDB_HTTP_BIND: 0.0.0.0:9010
      CXDB_LOG_LEVEL: ${CXDB_LOG_LEVEL:-info}
      CXDB_LOG_FORMAT: ${CXDB_LOG_FORMAT:-json}
      CXDB_ENABLE_METRICS: ${CXDB_ENABLE_METRICS:-false}
      CXDB_MAX_BLOB_SIZE: ${CXDB_MAX_BLOB_SIZE:-10485760}
      CXDB_COMPRESSION_LEVEL: ${CXDB_COMPRESSION_LEVEL:-3}
    networks:
      - cxdb-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9010/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # CXDB Gateway (Go OAuth proxy with embedded frontend)
  cxdb-gateway:
    build:
      context: ../..
      dockerfile: gateway/Dockerfile
    image: cxdb/gateway:latest
    container_name: cxdb-gateway
    restart: unless-stopped
    ports:
      - "${GATEWAY_PORT:-8080}:8080"
    volumes:
      - gateway-data:/data
    environment:
      PORT: 8080
      CXDB_BACKEND_URL: http://cxdb-server:9010
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_ALLOWED_DOMAIN: ${GOOGLE_ALLOWED_DOMAIN:-}
      GOOGLE_ALLOWED_EMAILS: ${GOOGLE_ALLOWED_EMAILS:-}
      SESSION_SECRET: ${SESSION_SECRET}
      DATABASE_PATH: /data/sessions.db
      SESSION_COOKIE_DOMAIN: ${SESSION_COOKIE_DOMAIN:-}
      ALLOWED_RENDERER_ORIGINS: ${ALLOWED_RENDERER_ORIGINS:-https://esm.sh,https://cdn.jsdelivr.net,https://unpkg.com}
      DEV_MODE: ${DEV_MODE:-}
    depends_on:
      cxdb-server:
        condition: service_healthy
    networks:
      - cxdb-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

networks:
  cxdb-network:
    driver: bridge

volumes:
  cxdb-data:
    driver: local
  gateway-data:
    driver: local
